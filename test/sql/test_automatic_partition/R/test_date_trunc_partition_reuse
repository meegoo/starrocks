-- name: test_date_trunc_partition_reuse
-- This test verifies that automatic partition creation (Expression Range Partition) is idempotent.
-- We use RENAME PARTITION to simulate a scenario where the partition name check fails (name mismatch)
-- but the range already exists. In this case, the system should detect the range overlap
-- and if it's an automatic partition, it should skip creation instead of throwing an error.

CREATE TABLE t_date_trunc_reuse (
    k1 DATETIME,
    v1 INT
)
ENGINE=OLAP
DUPLICATE KEY(k1)
PARTITION BY date_trunc('day', k1)
DISTRIBUTED BY HASH(k1) BUCKETS 1
PROPERTIES (
    "replication_num" = "1"
);
-- result:
-- !result

INSERT INTO t_date_trunc_reuse VALUES ("2024-01-01 10:00:00", 1);
-- result:
-- !result

SELECT * FROM t_date_trunc_reuse ORDER BY k1;
-- result:
2024-01-01 10:00:00	1
-- !result

ALTER TABLE t_date_trunc_reuse RENAME PARTITION p20240101 p_renamed;
-- result:
-- !result

INSERT INTO t_date_trunc_reuse VALUES ("2024-01-01 11:00:00", 2);
-- result:
-- !result

SELECT * FROM t_date_trunc_reuse ORDER BY k1;
-- result:
2024-01-01 10:00:00	1
2024-01-01 11:00:00	2
-- !result
